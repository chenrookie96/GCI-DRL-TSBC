# DRL-TSBC 实现说明

## 文件说明

本项目基于单向示例代码改造为双向DRL-TSBC算法，主要文件如下：

### 核心文件

1. **drl_tsbc_brain.py** - DQN神经网络模块
   - 改动：状态空间5维→10维，动作空间2个→4个
   - 网络结构：12层隐藏层，每层500神经元（论文表2-2）
   - 实现论文算法2.1的网络训练逻辑

2. **drl_tsbc_environment.py** - 双向公交仿真环境
   - 改动：从单向改为双向同时仿真
   - 实现论文公式2.1-2.17（状态空间和奖励函数）
   - 包含Station、Bus、DirectionSystem、BidirectionalBusSystem类

3. **train_drl_tsbc.py** - 训练脚本
   - 改动：实现论文算法2.1的完整训练流程
   - 同时训练上下行两个方向

4. **inference_drl_tsbc.py** - 推理脚本
   - 改动：实现论文算法2.2的推理流程
   - 包含后处理算法确保上下行发车次数相等

5. **config_drl_tsbc.py** - 配置文件
   - 集中管理所有参数（对应论文表2-1和表2-2）

6. **data_loader.py** - 数据加载模块（新增）
   - 统一管理所有数据加载逻辑
   - 参考`cal_pass_arr.py`的乘客到站时间估算方法
   - 自动验证数据完整性
   - 支持208和211两条线路

## 主要改动总结

### 1. 状态空间（5维→10维）
```
原始（单向）: [时间, 满载率, 等待时间, 容量利用率, 发车次数]
改造（双向）: [a1, a2, x1, x2, x3, x4, y1, y2, y3, y4]
```
- a1, a2: 时间状态（论文公式2.2-2.3）
- x1-x4: 上行状态（论文公式2.4-2.7）
- y1-y4: 下行状态（论文公式2.11-2.14）

### 2. 动作空间（2个→4个）
```
原始: {0: 不发车, 1: 发车}
改造: {0: (0,0), 1: (0,1), 2: (1,0), 3: (1,1)}
```
- (aup, adown): 上行和下行的发车决策

### 3. 网络结构
```
原始: 9层 × 300神经元
改造: 12层 × 500神经元（论文表2-2要求）
```

### 4. 奖励函数
```
原始: 单向奖励
改造: r = rup + rdown（论文公式2.15-2.17）
```
- 增加发车次数平衡项 ζ(cup - cdown)

### 5. 训练流程
```
原始: 分别训练上下行
改造: 同时训练双向（论文算法2.1）
```

## 使用方法

### 0. 系统测试（推荐首次运行）
```bash
python test_system.py
```
- 检查所有依赖是否安装
- 验证数据文件是否存在
- 测试网络、数据加载和环境是否正常

### 1. 数据检查
```bash
python data_loader.py
```
- 检查数据文件完整性
- 显示数据统计信息

### 2. 训练模型
```bash
python train_drl_tsbc.py
```
- 默认训练50个episode（论文表2-2：E=50）
- 预热3000步后开始训练（经验池填满）
- 每5步训练一次，每100次学习更新目标网络
- 模型保存在 `./test_data/208/drl_tsbc_model_208_1000.pth`
- 自动加载和验证数据

**训练轮数说明**：
- 论文规定：50 episodes（E=50）
- 单向示例：500 episodes（更充分训练）
- 建议：先用50复现论文，如效果不佳可增加到500

### 3. 推理生成时刻表
```bash
python inference_drl_tsbc.py
```
- 使用训练好的模型生成时刻表
- 自动调整确保上下行发车次数相等（论文算法2.2）
- 结果保存在 `./test_data/208/drl_tsbc_result_208_1000.txt`

### 4. 查看配置
```bash
python config_drl_tsbc.py
```
- 显示所有参数配置

## 参数配置

所有参数在 `config_drl_tsbc.py` 中配置，主要包括：

### DQN网络参数（论文表2-2）
- 学习率: 0.001
- 批次大小: 64
- 折扣系数γ: 0.4
- 经验池大小M: 3000
- ε: 0.1
- 隐层数: 12
- 隐层神经元数: 500

### 奖励函数参数
- μ: 5000（等待时间归一化）
- δ: 200（发车次数差异归一化）
- β: 0.2（滞留乘客惩罚）
- ζ: 0.002（发车次数平衡）

### 线路参数（论文表2-1）
- 208线: 上行26站，下行24站，6:00-21:00
- 211线: 上行17站，下行11站，6:00-22:00

### 均匀排班参数（可选功能）
- avg_flag: 均匀排班控制标志
  - 0: 不使用均匀排班
  - 1: 特定区间等间隔排班（默认：10:00-16:00，间隔12分钟）
  - 2: 方差最小化均匀调整（全局）
  - 3: 方差最小化均匀调整（特定区间）
- start_time: 均匀排班开始时间（默认：10:00）
- end_time: 均匀排班结束时间（默认：16:00）
- ideal_interval: 理想发车间隔（默认：12分钟）

## 数据要求

需要以下数据文件（在 `./test_data/208/` 目录下）：
1. `passenger_dataframe_direction0.csv` - 上行乘客数据
2. `passenger_dataframe_direction1.csv` - 下行乘客数据
3. `traffic-0.csv` - 上行交通状况
4. `traffic-1.csv` - 下行交通状况

### 乘客数据格式
必需列：
- `Label`: 乘客唯一标识
- `Boarding time`: 上车时间（分钟）
- `Boarding station`: 上车站点（0开始）
- `Alighting station`: 下车站点
- `Arrival time`: 到达站点时间（可选，如无则自动估算）

### 交通数据格式
- 前6列：时间信息（time_h1, time_h2, time_m1, time_m2, start_m, finish_m）
- 后续列：各站点间行驶时间

### 数据检查
运行以下命令检查数据文件：
```bash
python data_loader.py
```

## 与原始代码的对应关系

| 原始文件 | 改造后文件 | 说明 |
|---------|-----------|------|
| RL_brain.py | drl_tsbc_brain.py | 网络结构改为12层×500 |
| Environment.py | drl_tsbc_environment.py | 单向→双向环境 |
| work_env.py | inference_drl_tsbc.py | 推理+后处理 |
| - | train_drl_tsbc.py | 新增训练脚本 |
| - | config_drl_tsbc.py | 新增配置文件 |

## 预期结果

根据论文表2-3，208线预期结果：
- 上行发车次数: 73次
- 下行发车次数: 73次
- 上行平均等待时间: 3.7分钟
- 下行平均等待时间: 3.8分钟
- 滞留乘客: 0

## 注意事项

1. 确保CUDA可用以加速训练（论文要求使用GPU）
2. 训练时间较长，建议使用GPU
3. 首次运行需要完整训练50个episode
4. 推理前确保模型文件存在
